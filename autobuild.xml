<project name="EclipseLink Automated Build" basedir="." default="build.nightly">
<echo message="---- AutoBuild.xml ----"/>

    <target name="build.no.publish" depends="clean, build, build.test"                      description="Trigger the automated build without testing or publish"/>
    <target name="build.nightly"    depends="clean, build, build.test, test.lrg, publish"   description="Trigger the nightly automated build and lrg tests" />
    <target name="build.continuous" depends="clean, build.no.javadoc, build.test, test.srg" description="Trigger the automated build and run the tests" />

    <target name="init">
        <property file="${basedir}/autobuild.properties"/>

        <condition property="installer_id" value="${build_date}">
            <equals arg1="${build_id}" arg2="SNAPSHOT"/>
        </condition>
        <property name="installer_id" value="${release.version}${build_id}"/>
        <condition property="download.path" value="${eclipse.download.path}/nightly">
            <equals arg1="${build_id}" arg2="SNAPSHOT"/>
        </condition>
        <property name="download.path" value="${eclipse.download.path}"/>

        <echo message="ANT_ARGS='${env.ANT_ARGS}'"/>
        <echo message="ANT_OPTS='${env.ANT_OPTS}'"/>
        <echo message=" "/>
        <echo message="build_date.build_time='${build_date}.${build_time}'"/>
        <echo message="java.version='${java.version}'"/>
        <echo message="basedir='${basedir}'"/>
        <echo message="os.name='${os.name}'"/>
        <echo message="os.arch='${os.arch}'"/>
        <echo message="os.version='${os.version}'"/>
    </target>

    <target name="clean" depends="init">
        <!-- Removed because build-clean should take care of old build artifacts,
             and svn should update source (including removing renamed, deleted files).
            delete dir="${build.root}"/ -->
        <delete dir="${build.root}/${junit.bundle}"/>
        <delete file="${build.root}/junit.zip"/>
        <ant antfile="build.xml" dir="${build.root}" target="clean"/>
    </target>

    <target name="get.dependencies" depends="clean">
        <get src="http://download.eclipse.org/tools/orbit/downloads/drops/${junit.drop}/bundles/${junit.zip}" dest="junit.zip"/>
        <unzip src="junit.zip" dest="${basedir}"/>
    </target>

    <target name="build" depends="get.dependencies">
        <ant antfile="build.xml" dir="${build.root}" target="build.distribution"/>
    </target>

    <target name="build.no.javadoc" depends="get.dependencies">
        <ant antfile="build.xml" dir="${build.root}" target="package.eclipselink.jar"/>
    </target>

    <target name="build.test" depends="get.dependencies">
        <ant antfile="build.xml" dir="${build.root}" target="build.test"/>
    </target>

    <target name="test.srg">
        <ant antfile="build.xml" dir="${build.root}" target="test.core.srg"/>
    </target>

    <target name="test.lrg">
        <ant antfile="build.xml" dir="${build.root}" target="test.core.srg"/>
        <ant antfile="build.xml" dir="${build.root}" target="test.jpa"/>
        <ant antfile="build.xml" dir="${build.root}" target="test.moxy"/>
        <ant antfile="build.xml" dir="${build.root}" target="test.sdo"/>
    </target>

    <target name="publish">
        <copy file="${build.root}/${eclipselink.zip.name}${eclipselink.zip.extension}" tofile="${download.path}/${eclipselink.zip.name}-${installer_id}${eclipselink.zip.extension}"/>
        <copy file="${build.root}/foundation/eclipselink.core.test/reports/junit-noframes.html" tofile="${download.path}/test-results/core/eclipselink-srg-${installer_id}.html"/>
        <copy file="${build.root}/jpa/eclipselink.jpa.test/reports/junit-noframes.html" tofile="${download.path}/test-results/jpa/eclipselink-jpa-lrg-${installer_id}.html"/>
        <copy file="${build.root}/moxy/eclipselink.moxy.test/reports/jaxb/junit-noframes.html" tofile="${download.path}/test-results/moxy/eclipselink-jaxb-lrg-${installer_id}.html"/>
        <copy file="${build.root}/moxy/eclipselink.moxy.test/reports/oxm/junit-noframes.html" tofile="${download.path}/test-results/moxy/eclipselink-oxm-lrg-${installer_id}.html"/>
        <copy file="${build.root}/sdo/eclipselink.sdo.test/reports/true/junit-noframes.html" tofile="${download.path}/test-results/sdo/eclipselink-sdo-lrg-${installer_id}.html"/>
        <exec executable="${svn.exec}">
            <arg value="commit"/>
            <arg value="-m ${installer_id}"/>
            <arg value="${build.root}/${eclipselink.jar.name}"/>
        </exec>
        <ant antfile="uploadToMaven.xml" dir="${build.root}" target="upload.maven"/>
    </target>

</project>
